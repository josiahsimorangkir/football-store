{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Football Store</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="bg-gray-50 w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Header Section  -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Latest Football Product</h1>
    </div>

    <div class="flex flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-lg border border-gray-200 p-4"> 
      <div class="flex space-x-3 mb-4 sm:mb-0">
      <!-- Button to open modal -->
        <button onclick="showModal()" class="inline-flex items-center px-4 py-2 bg-white text-green-600 font-semibold outline outline-2 outline-green-600 outline-offset-[-2px] rounded-md hover:bg-green-600 hover:text-white transition-colors mb-4">
          Create Product by AJAX
        </button>

        <button 
          id="refreshButton" 
          class="inline-flex items-center bg-blue-600 text-white px-4 py-2 rounded-md shadow hover:bg-blue-600 transition mb-4">
          ðŸ”„ Refresh
        </button>
      </div>
    </div>
    

    

    <!-- Filter Section -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-lg border border-gray-200 p-4">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <a id="filter-all" href="?" class="{% if request.GET.filter == 'all' or not request.GET.filter %} bg-blue-600 text-white{% else %}bg-white text-gray-700 border border-gray-300{% endif %} px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-600 hover:text-white">
          All Products
            </a>
        <a id="filter-my" href="?filter=my" class="{% if request.GET.filter == 'my' %} bg-blue-600 text-white{% else %}bg-white text-gray-700 border border-gray-300{% endif %} px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-600 hover:text-white">
          My Products
          </a>

      </div>
      {% if user.is_authenticated %}
        <div class="text-sm text-gray-500">
          Last login: {{ last_login }}
        </div>
      {% endif %}
    </div>

    <!-- Loading State -->
    <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <svg class="animate-spin h-8 w-8 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Loading products...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden bg-white rounded-lg border border-gray-200 p-8 text-center text-red-600 font-medium">
      Something went wrong while loading products.
    </div>

    <!-- Empty State -->
    <div id="empty" class="hidden bg-white rounded-lg border border-gray-200 p-12 text-center">
      <div class="w-32 h-32 mx-auto mb-4">
        <img src="{% static 'image/no-products.png' %}" alt="No products available" class="w-full h-full object-contain">
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
      <p class="text-gray-500 mb-6">Be the first to share football products with the community.</p>
      <a href="{% url 'main:create_product' %}" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
        Create Product
      </a>
    </div>

    <!-- Product Grid -->
    <div id="grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for product in product_list %}
        {% include 'card_product.html' with product=product %}
      {% endfor %}
    </div>

  </div>
</div>
{% include 'modal.html' %}

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Config
  const PRODUCT_API_ENDPOINT = "{% url 'main:show_json' %}";
  const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

  // DOM
  const loadingSpinner = document.getElementById('loading');
  const errorMessage = document.getElementById('error');
  const emptyStateDisplay = document.getElementById('empty');
  const productGridContainer = document.getElementById('grid');
  const showAllProductButton = document.getElementById('filter-all');
  const showMyProductButton = document.getElementById('filter-my');

  // State
  let activeFilter = 'all';
  let allProductData = [];

  // Helper: get CSRF cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Clear product grid
  function clearGrid() {
    if (productGridContainer) productGridContainer.innerHTML = '';
  }

  // Update filter button visuals (simple)
  function updateFilterButtonsAppearance() {
    if (!showAllProductButton || !showMyProductButton) return;
    if (activeFilter === 'all') {
      showAllProductButton.className = 'bg-blue-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-700';
      showMyProductButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-600 hover:text-white';
    } else {
      showMyProductButton.className = 'bg-blue-600 text-white px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-700';
      showAllProductButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-600 hover:text-white';
    }
  }

  // Show/hide sections
  function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
    if (loadingSpinner) loadingSpinner.classList.toggle('hidden', !showLoading);
    if (errorMessage) errorMessage.classList.toggle('hidden', !showError);
    if (emptyStateDisplay) emptyStateDisplay.classList.toggle('hidden', !showEmpty);
    if (productGridContainer) productGridContainer.classList.toggle('hidden', !showGrid);
  }

  // Readable category (optional)
  function getReadableCategoryName(code) {
    const map = { sepatu:'Sepatu', baju:'Baju', aksesoris:'Aksesoris', celana:'Celana' };
    return map[code] || code || '';
  }

  // Build card element (returns <article>)
  function buildProductCardElement(item) {
    const article = document.createElement('article');
    article.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';
    article.dataset.productId = item.id;

    // sanitize small values
    const name = (item.name || '').toString();
    const description = (item.description || '').toString();
    const category = (item.category || '').toString();
    const thumbnail = item.thumbnail || '';
    const createdAt = item.created_at ? new Date(item.created_at).toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' }) : '';
    const productViews = item.product_views || 0;
    const isFeatured = !!item.is_featured;

    // build HTML (no user-supplied HTML is injected, we only use text values)
    const linkDetail = `{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
    const linkEdit = `{% url 'main:edit_product_entry_ajax' %}`;
    const deleteUrl = `{% url 'main:delete_product' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);

    const badgeHtml = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-600 text-white">${getReadableCategoryName(category)}</span>`;
    const featuredLabel = isFeatured ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">Featured</span>` : '';
    const hotLabel = productViews > 20 ? `<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800">Hot</span>` : '';

    const thumbHtml = thumbnail ? `<img src="${thumbnail}" alt="${name}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center"></div>`;

    article.innerHTML = `
      <div class="aspect-[16/9] relative overflow-hidden">
        ${thumbHtml}
        <div class="absolute top-3 left-3">${badgeHtml}</div>
        <div class="absolute top-3 right-3 flex space-x-2">${featuredLabel}${hotLabel}</div>
      </div>
      <div class="p-5 flex flex-col flex-1">
        <div class="flex items-center text-sm text-gray-500 mb-3">
          <time>${createdAt}</time>
          <span class="mx-2">â€¢</span>
          <span>${productViews} views</span>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-3 line-clamp-2 leading-tight">
          <a href="${linkDetail}" class="hover:text-blue-600 transition-colors">${name}</a>
        </h3>
        <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-4">${description}</p>
        <div class="pt-4 border-t border-gray-100 flex items-center justify-between">
          <a href="${linkDetail}" class="text-blue-600 hover:text-blue-700 font-medium text-sm transition-colors">Read more</a>
          <div class="actions-area"></div>
        </div>
      </div>
    `;

    // add edit/delete buttons if owner
    // ----- KODE BARU (BENAR) -----

if (CURRENT_USER_ID && String(CURRENT_USER_ID) === String(item.user_id)) {
  const actions = article.querySelector('.actions-area');
  
  // 1. Buat sebagai <button>, bukan <a>
  const editBtn = document.createElement('button');
  editBtn.type = 'button';
  editBtn.className = 'text-gray-600 hover:text-gray-700 text-sm transition-colors mr-3';
  editBtn.textContent = 'Edit';

  // 2. Saat diklik, panggil fungsi showEditModal dengan membawa data produk (item)
  editBtn.onclick = () => showEditModal(item);
  
  const delBtn = document.createElement('button');
  // ... (kode tombol delete tetap sama) ...
  delBtn.type = 'button';
  delBtn.className = 'text-red-600 hover:text-red-700 text-sm transition-colors';
  delBtn.textContent = 'Delete';
  delBtn.addEventListener('click', (ev) => {
    ev.preventDefault();
    showDeleteModal(item.id); // Panggil fungsi delete modal yg baru
  });
  
  // 3. Masukkan tombol baru ke DOM
  actions.appendChild(editBtn);
  actions.appendChild(delBtn);
}

    return article;
  }
  
  async function refreshProducts() {
    const container = document.getElementById("productContainer"); // pastikan ID-nya sesuai
    container.innerHTML = `<p class="text-gray-500 text-center py-10">Loading products...</p>`;

    try {
      const response = await fetch("{% url 'main:show_json' %}");
      if (!response.ok) throw new Error("Failed to fetch products");

      const products = await response.json();
      container.innerHTML = "";

      if (products.length === 0) {
        container.innerHTML = `<p class="text-gray-500 text-center py-10">No products found.</p>`;
        return;
      }

      products.forEach((item) => {
        const card = buildProductCardElement(item);
        container.appendChild(card);
      });

      showToast("Product list refreshed!", "", "success");
    } catch (error) {
      console.error(error);
      container.innerHTML = `<p class="text-red-500 text-center py-10">Error loading products.</p>`;
      showToast("Failed to refresh products", "", "error");
    }
  }

  // Event listener untuk tombol refresh
  document.getElementById("refreshButton").addEventListener("click", () => {
    refreshProducts();
  });

  // Render cards (clear first to avoid duplicates)
  function renderAllProductCards(productItems) {
    if (!productGridContainer) return;
    clearGrid(); // important: remove old cards to prevent duplicates
    // keep a set to avoid duplicate ids (extra safety)
    const seen = new Set();
    productItems.forEach(productItem => {
      if (!productItem || !productItem.id) return;
      if (seen.has(productItem.id)) return;
      seen.add(productItem.id);
      const cardElement = buildProductCardElement(productItem);
      productGridContainer.appendChild(cardElement);
    });
  }

  // Delete product via POST (assumes backend accepts POST on delete URL)
  async function deleteProduct(id, articleEl, deleteUrl) {
    if (!confirm('Are you sure you want to delete this product?')) return;
    try {
      const csrftoken = getCookie('csrftoken');
      const res = await fetch(deleteUrl, {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'X-CSRFToken': csrftoken },
      });

      if (res.ok) {
        showToast('Product deleted', '', 'success');
        // remove card from DOM (if articleEl provided)
        if (articleEl && articleEl.parentNode) {
          articleEl.remove();
          // optionally update local state
          allProductData = allProductData.filter(p => String(p.id) !== String(id));
          // if grid empty now -> show empty
          if (!productGridContainer.children.length) displayPageSection({ showEmpty:true });
        } else {
          // fallback: refresh list
          fetchProductFromServer();
        }
      } else {
        const text = await res.text();
        console.error('delete failed', res.status, text);
        showToast('Failed to delete', text || '', 'error');
      }
    } catch (err) {
      console.error('deleteProduct error', err);
      showToast('Failed to delete', err.message || '', 'error');
    }
  }

  // Filter and show
  function filterAndDisplayProduct() {
    updateFilterButtonsAppearance();
    const filteredProducts = activeFilter === 'all'
      ? allProductData
      : allProductData.filter(product => String(product.user_id) === String(CURRENT_USER_ID));

    if (!filteredProducts || filteredProducts.length === 0) {
      displayPageSection({ showEmpty: true });
    } else {
      renderAllProductCards(filteredProducts);
      displayPageSection({ showGrid: true });
    }
  }

  // Fetch from server
  async function fetchProductFromServer() {
    try {
      displayPageSection({ showLoading: true });
      const res = await fetch(PRODUCT_API_ENDPOINT, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('Failed to fetch product data from server: ' + res.status);
      const productData = await res.json();
      allProductData = Array.isArray(productData) ? productData : (productData.results || []);
      filterAndDisplayProduct();
    } catch (err) {
      console.error('Error loading products:', err);
      displayPageSection({ showError: true });
    }
  }

  // Event handlers
  if (showAllProductButton) showAllProductButton.addEventListener('click', (e) => { e.preventDefault(); activeFilter='all'; filterAndDisplayProduct(); });
  if (showMyProductButton) showMyProductButton.addEventListener('click', (e) => { e.preventDefault(); activeFilter='my'; filterAndDisplayProduct(); });

  // Init
  //  - clear server-rendered cards to avoid duplicates on first JS render
  clearGrid();
  fetchProductFromServer();

  // Refresh after product added
  document.addEventListener('productAdded', () => {
    fetchProductFromServer();
  });

});
</script>

{% endblock content %}
